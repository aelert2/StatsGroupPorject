---
title: "README"
author: "Amanda Elert"
date: "4/13/2020"
output: md_document
---

# Loading the libraries needed
```{r}
rm(list = ls())

library(data.table)
library(tidyverse)
library(ggrepel)
```

# Background about the data
Our project covers [NFL play-by-play data from 2009 to 2018 from Kaggle](https://www.kaggle.com/maxhorowitz/nflplaybyplay2009to2016), and we are using betting data from Kaggle (link to data here) to contextualize the play-by-play data.
<br>
<br>
The [extra point yard line was moved](http://www.nfl.com/news/story/0ap3000000493347/article/nfl-moves-extra-point-to-15yard-line-for-2015-season
) from the 2-yardline to the 15-yardline in 2015 because the NFL wanted to increase the number of 2-point conversion attempts to boast ratings. We want to analyze how attempting more 2-point conversions, especially in the 4th quarter, can benefit teams.

# Data Cleaning
[Follow this link for using an open source Git extension to deal with versioning large files.](https://git-lfs.github.com/) This is how we were able to load the large play-by-play dataset.
```{r}
nfl_data <-  read_csv("NFLPlaybyPlay 2009-2018.csv")
spread_data = read.csv("spreadspoke_scores.csv")
spread_data$newdate <- strptime((spread_data$schedule_date), "%m/%d/%Y")
spread_data$newdate = format(spread_data$newdate, "%Y-%m-%d")
spread_data$newdate = as.Date(as.character(spread_data$newdate))

spread_data$home_team_abbv <- ifelse(spread_data$team_home=="Arizona Cardinals", "ARI",
                                     ifelse(spread_data$team_home=="Atlanta Falcons", "ATL", 
                                            ifelse(spread_data$team_home=="Baltimore Ravens", "BAL",
                                                   ifelse(spread_data$team_home=="Buffalo Bills", "BUF",
                                                          ifelse(spread_data$team_home=="Carolina Panthers", "CAR",
                              ifelse(spread_data$team_home=="Chicago Bears", "CHI",
                                      ifelse(spread_data$team_home=="Cincinnati Bengals", "CIN",
                                            ifelse(spread_data$team_home=="Cleveland Browns", "CLE",
                                                   ifelse(spread_data$team_home=="Dallas Cowboys", "DAL",
                                                          ifelse(spread_data$team_home=="Denver Broncos", "DEN", 
                              ifelse(spread_data$team_home=="Detroit Lions", "DET",
                                     ifelse(spread_data$team_home=="Green Bay Packers", "GB",
                                            ifelse(spread_data$team_home=="Houston Texans", "HOU",
                                                   ifelse(spread_data$team_home=="Indianapolis Colts", "IND",
                              ifelse(spread_data$team_home=="Jacksonville Jaguars", "JAX",
                                     ifelse(spread_data$team_home=="Kansas City Chiefs", "KC",
                                            ifelse(spread_data$team_home=="Los Angeles Rams", "LA",
                                                   ifelse(spread_data$team_home=="Los Angeles Chargers", "LAC",
                              ifelse(spread_data$team_home=="Miami Dolphins", "MIA",
                                     ifelse(spread_data$team_home=="Minnesota Vikings", "MIN",
                                            ifelse(spread_data$team_home=="New England Patriots", "NE",
                                                ifelse(spread_data$team_home=="New Orleans Saints", "NO",
                              ifelse(spread_data$team_home=="New York Giants", "NYG",
                                     ifelse(spread_data$team_home=="New York Jets", "NYJ",
                                            ifelse(spread_data$team_home=="Oakland Raiders", "OAK",
                                                   ifelse(spread_data$team_home=="Philadelphia Eagles", "PHI",
                              ifelse(spread_data$team_home=="Pittsburgh Steelers", "PIT",
                                     ifelse(spread_data$team_home=="San Diego Chargers", "SD",
                                            ifelse(spread_data$team_home=="Seattle Seahawks", "SEA",
                              ifelse(spread_data$team_home=="San Francisco 49ers", "SF",
                                     ifelse(spread_data$team_home=="St. Louis Rams", "STL",
                                            ifelse(spread_data$team_home=="Tampa Bay Buccaneers", "TB",
                              ifelse(spread_data$team_home=="Tennessee Titans", "TEN",
                                     ifelse(spread_data$team_home=="Washington Redskins", "WAS", "NA"
                                            ))))))))))))))))))))))))))))))))))

#Jacksonville's abbreviation changed from JAC to JAX in 2013
nfl_data$home_team <- ifelse(nfl_data$home_team == "JAC", "JAX", nfl_data$home_team)

colnames(spread_data)[19] <- "home_team"
colnames(spread_data)[18] <- "game_date"
glimpse(spread_data)

nfl_data <- nfl_data %>% 
                left_join(spread_data, by=c("game_date", "home_team"))

post_td_plays <- nfl_data %>% 
  select(play_id,
         game_id,
         home_team,
         away_team,
         posteam,
         posteam_type,
         defteam,
         posteam_score,
         defteam_score,
         score_differential,
         posteam_score_post,
         defteam_score_post,
         score_differential_post,
         desc,
         game_date,
         qtr,
         game_seconds_remaining,
         play_type,
         yards_gained,
         contains("two_point"),
         kicker_player_name,
         kicker_player_id,
         blocked_player_id,
         blocked_player_name,
         contains("extra_point"),
         wp,
         def_wp,
         home_wp,
         away_wp,
         wpa,
         home_wp_post,
         away_wp_post,
         ydsnet, 
         ep, 
         epa,
         shotgun,
         qb_dropback,
         team_favorite_id, 
         spread_favorite, 
         over_under_line, 
         stadium,
         stadium_neutral, 
         weather_temperature,
         weather_wind_mph,
         weather_humidity,
         weather_detail)%>% 
  mutate(year = substr(game_id, 1, 4)) %>%
  filter(extra_point_attempt == 1 | two_point_attempt == 1 | defensive_extra_point_attempt == 1 | defensive_two_point_attempt == 1)

post_td_plays$home_team <- as.factor(as.character(post_td_plays$home_team))
post_td_plays$away_team <- as.factor(as.character(post_td_plays$away_team))
post_td_plays$team_favorite_id <- as.factor(as.character(post_td_plays$team_favorite_id))

#Create one column that separates the types of extra point(s) try
post_td_plays <- post_td_plays %>% 
  mutate(extra_point_type = ifelse(extra_point_attempt == 1,
                               "Kick", "Two-PointConversion"))


# Ratio of XPT:2PT attempts
post_td_plays %>% 
  group_by(year, extra_point_attempt, two_point_attempt) %>% 
  summarise(n = n())

#Mean WPA change based on play type for post-touchdown 
post_td_plays %>% 
  group_by(play_type) %>% 
  summarise(mean(wpa, na.rm = T))

```

# Data Visualization
```{r}
# 2-pt Conversion Distribution
post_td_plays %>% 
  filter(two_point_attempt == 1) %>% 
  group_by(year, two_point_conv_result) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, group = two_point_conv_result)) +
  geom_line(aes(color = two_point_conv_result)) +
  geom_point(aes(color = two_point_conv_result)) +
  annotate(geom="text", x='2016', y=49, label="2015: XPT moved from 2YL to 15YL", color="darkgray") +
  labs(title="Plot of 2-pt Conversions in the NFL from 2009 to 2018",x="Year", y = "Count")

# XPT Conversion Distribution
post_td_plays %>% 
  filter(extra_point_attempt == 1) %>% 
  group_by(year, extra_point_result) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = year, y = n, group = extra_point_result)) +
  geom_line(aes(color = extra_point_result)) +
  geom_point(aes(color = extra_point_result)) +
  annotate(geom="text", x='2016', y=1100, label="2015: XPT moved from 2YL to 15YL", color="darkgray") +
  labs(title="Plot of Extra Points in the NFL from 2009 to 2018", x="Year", y = "Count")

#Graph 4th quarter win probability changes based on type of extra point try
post_td_plays %>% 
  filter(qtr == 4) %>% 
  ggplot(., aes(x=game_seconds_remaining, y=wpa, 
                                 color=extra_point_type)) + geom_point() + scale_x_reverse() +
  ggtitle("Win Probability Shifts in the 4th Quarter")

#Graph 4th quarter, 7 minutes left win probability changes based on type of extra point try
post_td_plays %>% 
  filter(qtr == 4, game_seconds_remaining <= 420) %>% 
  ggplot(., aes(x=game_seconds_remaining, y=wpa, 
                color=extra_point_type)) + geom_point() + scale_x_reverse()  +
  ggtitle("Win Probability Shifts in the last 7 min")
```

# Data Modeling
```{r}
#str(post_td_plays)
post_td_plays$posteam <- as.factor(post_td_plays$posteam)
post_td_plays$defteam <- as.factor(post_td_plays$defteam)
post_td_plays$play_type <- as.factor(post_td_plays$play_type)
post_td_plays$two_point_attempt <- as.factor(post_td_plays$two_point_attempt)
post_td_plays$two_point_conv_result <- as.factor(post_td_plays$two_point_conv_result)
post_td_plays$kicker_player_id <- as.factor(post_td_plays$kicker_player_id)
post_td_plays$extra_point_attempt <- as.factor(post_td_plays$extra_point_attempt)
post_td_plays$extra_point_result <- as.factor(post_td_plays$extra_point_result)
post_td_plays$year <- as.factor(post_td_plays$year)
post_td_plays$shotgun <- as.factor(as.character(post_td_plays$shotgun))
post_td_plays$qb_dropback <- as.factor(as.character(post_td_plays$qb_dropback))

glimpse(nfl_data)
#summary(post_td_plays)

# mod1 <- lm(wpa ~ posteam + defteam + score_differential + play_type + two_point_attempt + two_point_conv_result + kicker_player_id + extra_point_attempt + extra_point_result + year, data = post_td_plays)

#Regression to see influential factors for two-point conversions specifcially
#Just a test, planning to further develop
lm_twopoint <- post_td_plays %>% 
  filter(extra_point_type == "Two-PointConversion") %>% 
  lm(wpa ~ posteam + defteam + game_seconds_remaining + ydsnet + score_differential + epa, data = .)
summary(lm_twopoint)
```